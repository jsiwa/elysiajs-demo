# ğŸ”§ é—®é¢˜ä¿®å¤æ€»ç»“

## ä¿®å¤çš„é—®é¢˜

### 1. âŒ ç™»å½•å¤±è´¥ï¼šæœåŠ¡å™¨é”™è¯¯
**é—®é¢˜**: æ‰€æœ‰é¡µé¢è¿”å› `{"name":"TypeError","message":"undefined is not an object (evaluating 'session.value')"}`

**åŸå› **: 
- Cookie è®¿é—®æ–¹å¼ä¸å®‰å…¨ï¼Œç›´æ¥è§£æ„ `{ cookie: { session } }` å¯¼è‡´ `session` ä¸º `undefined`
- ä¼šè¯å­˜å‚¨æ²¡æœ‰åœ¨æ¨¡å—é—´æ­£ç¡®å…±äº«

**ä¿®å¤**:
```typescript
// ä¿®å¤å‰
.derive(({ cookie: { session } }) => {
  const sessionId = session.value // âŒ session å¯èƒ½ä¸º undefined
})

// ä¿®å¤å  
.derive(({ cookie }) => {
  const session = cookie?.session // âœ… å®‰å…¨è®¿é—®
  const sessionId = session?.value
})
```

### 2. âŒ å¤šè¯­è¨€ç®¡ç†åå°è®¿é—®é—®é¢˜
**é—®é¢˜**: `/zh/admin/files` ç­‰å¤šè¯­è¨€è·¯ç”±æ— æ³•æ­£å¸¸å·¥ä½œ

**åŸå› **:
- ä¼šè¯åœ¨ä¸åŒè¯­è¨€è·¯ç”±é—´æ²¡æœ‰æ­£ç¡®å…±äº«
- æƒé™æ£€æŸ¥ä¸­é—´ä»¶é…ç½®ä¸å½“
- ä¸­æ–‡ç¿»è¯‘æ–‡ä»¶ç¼ºå°‘ `admin` éƒ¨åˆ†

**ä¿®å¤**:
1. **ä¼šè¯å…±äº«**: å¯¼å‡ºä¼šè¯å­˜å‚¨ä¾›æ‰€æœ‰æ¨¡å—ä½¿ç”¨
```typescript
// simple-auth.routes.ts
export const sessions = new Map<string, any>()

// admin.routes.ts  
import { sessions } from '../auth/simple-auth.routes'
```

2. **æƒé™ä¸­é—´ä»¶**: æ·»åŠ ç»Ÿä¸€çš„ç®¡ç†å‘˜æƒé™æ£€æŸ¥
```typescript
.guard({
  beforeHandle({ user, set, request }) {
    if (!user) {
      // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
      set.redirect = `/login?redirect=${encodeURIComponent(redirectPath)}`
      return
    }
    if (user.role !== 'admin') {
      // è¿”å›403é”™è¯¯é¡µé¢
      set.status = 403
      return accessDeniedPage
    }
  }
})
```

3. **å¤šè¯­è¨€ç¿»è¯‘**: ä¸ºä¸­æ–‡æ·»åŠ å®Œæ•´çš„ `admin` ç¿»è¯‘
```json
{
  "admin": {
    "dashboard": { "title": "ç®¡ç†ä»ªè¡¨æ¿", ... },
    "fileManager": { "title": "æ–‡ä»¶ç®¡ç†å™¨", ... },
    ...
  }
}
```

### 3. âœ… ç™»å½•é‡å®šå‘åŠŸèƒ½
**æ–°å¢**: ç™»å½•æˆåŠŸåè‡ªåŠ¨é‡å®šå‘åˆ°åŸå§‹è¯·æ±‚é¡µé¢
```javascript
// æ£€æŸ¥URLå‚æ•°ä¸­çš„é‡å®šå‘åœ°å€
const urlParams = new URLSearchParams(window.location.search);
const redirectTo = urlParams.get('redirect');

if (redirectTo) {
  window.location.href = redirectTo;
} else if (result.user.role === 'admin') {
  window.location.href = '/admin';
} else {
  window.location.href = '/';
}
```

## ğŸ§ª æµ‹è¯•é¡µé¢

åˆ›å»ºäº†ä¸‰ä¸ªæµ‹è¯•é¡µé¢æ¥éªŒè¯ä¿®å¤ï¼š

### 1. `/test-login` - åŸºç¡€ç™»å½•æµ‹è¯•
- æµ‹è¯•ç™»å½•APIåŠŸèƒ½
- å¿«é€Ÿç™»å½•æ¼”ç¤ºè´¦å·
- ä¼šè¯çŠ¶æ€æ£€æŸ¥

### 2. `/test-admin` - ç®¡ç†åå°æµ‹è¯•  
- å®Œæ•´çš„ç®¡ç†åŠŸèƒ½æµ‹è¯•
- æƒé™éªŒè¯
- å¤šè¯­è¨€è·¯ç”±æµ‹è¯•

### 3. `/test-i18n` - å¤šè¯­è¨€åŠŸèƒ½æµ‹è¯•
- æ‰€æœ‰è¯­è¨€è·¯ç”±æµ‹è¯•
- ç®¡ç†åå°å¤šè¯­è¨€è®¿é—®
- è®¤è¯çŠ¶æ€åœ¨ä¸åŒè¯­è¨€é—´çš„ä¿æŒ

## ğŸŒ å¤šè¯­è¨€æ”¯æŒçŠ¶æ€

| è¯­è¨€ | ä»£ç  | é¦–é¡µ | ç®¡ç†åå° | æ–‡ä»¶ç®¡ç†å™¨ | ç¿»è¯‘å®Œæ•´åº¦ |
|------|------|------|----------|------------|------------|
| English | `en` | `/` | `/admin` | `/admin/files` | âœ… 100% |
| ä¸­æ–‡ | `zh` | `/zh` | `/zh/admin` | `/zh/admin/files` | âœ… 100% |
| æ—¥æœ¬èª | `ja` | `/ja` | `/ja/admin` | `/ja/admin/files` | âœ… 100% |

## ğŸ” æ¼”ç¤ºè´¦å·

| è§’è‰² | é‚®ç®± | å¯†ç  | æƒé™ |
|------|------|------|------|
| ç®¡ç†å‘˜ | admin@example.com | admin123 | å®Œæ•´ç®¡ç†æƒé™ |
| æ¼”ç¤ºç”¨æˆ· | demo@example.com | demo123 | ç®¡ç†æƒé™ |
| æ™®é€šç”¨æˆ· | user@example.com | user123 | åŸºç¡€æƒé™ |

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•

1. **å¯åŠ¨åº”ç”¨**:
```bash
bun dev
```

2. **å¿«é€Ÿæµ‹è¯•**:
```bash
# åŸºç¡€åŠŸèƒ½æµ‹è¯•
curl http://localhost:3000/

# ç™»å½•æµ‹è¯•  
node debug-auth.js

# æˆ–ä½¿ç”¨æµè§ˆå™¨æµ‹è¯•é¡µé¢
open http://localhost:3000/test-i18n
```

3. **å®Œæ•´æµ‹è¯•æµç¨‹**:
   - è®¿é—® `/test-i18n`
   - ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"
   - æ£€æŸ¥å„è¯­è¨€è·¯ç”±çŠ¶æ€
   - æµ‹è¯•ç®¡ç†å‘˜ç™»å½•å’Œæƒé™

## ğŸ“ æ–‡ä»¶å­˜å‚¨

- **é»˜è®¤**: ä½¿ç”¨æ¨¡æ‹Ÿå­˜å‚¨ï¼ˆæ— éœ€é…ç½®ï¼‰
- **ç”Ÿäº§**: é…ç½® `.env` æ–‡ä»¶è¿æ¥ Cloudflare R2
- **æ¼”ç¤ºæ–‡ä»¶**: é¢„ç½®äº†ç¤ºä¾‹å›¾ç‰‡ã€æ–‡æ¡£ç­‰æ–‡ä»¶

## âœ… ä¿®å¤éªŒè¯

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤å¹¶é€šè¿‡æµ‹è¯•ï¼š
- âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸
- âœ… ä¼šè¯ç®¡ç†æ­£ç¡®
- âœ… å¤šè¯­è¨€è·¯ç”±å·¥ä½œ
- âœ… ç®¡ç†åå°æƒé™æ§åˆ¶
- âœ… æ–‡ä»¶ç®¡ç†å™¨å¤šè¯­è¨€æ”¯æŒ
- âœ… é‡å®šå‘åŠŸèƒ½æ­£å¸¸

ç°åœ¨åº”ç”¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼